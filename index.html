<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>HIDOE Thermal Comfort Analysis</title>
        <script type="text/javascript" src="d3/d3.js"></script>
        <script type="text/javascript" src="https://d3js.org/d3-queue.v2.min.js"></script>
        <style type="text/css">

            body {
                font-family: Helvetica;
                font-size: 10px;
                color: #535353;
            }

            h2 {
                margin-left: 10px;
            }

            p {
                margin-left: 10px;
            }

            .line {
                fill: none;
                stroke: #104E8B;
                stroke-width: 0.4px;
                opacity: 0.6;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: dimgrey;
                shape-rendering: crispEdges;
                stroke-width : 0.4px;
            }

            .axis text {
                font-family: Helvetica;
                font-size: 6px;
                color: #535353;
                stroke-width: 0.2px;
            }



        </style>
    </head>
    <body>
        <h2>Universal Thermal Climate Index Profile</h2>


        <p id="schoolmenu" class="menuchoice">School: <select>
            <option value="school1">Ala Wai El</option>
            <option value="school2">Barbers Point El</option>
            <option value="school3">Campbell High</option>
            <option value="school4">Ewa Beach El</option>
            <option value="school5">Ewa El</option>
            <option value="school6">Hokulani El</option>
            <option value="school7">Ilima Int</option>
            <option value="school8">Kaimiloa El</option>
            <option value="school9">Kalaheo High</option>
            <option value="school10">Koko Head El</option>
            <option value="school8">Mokulele El</option>
            <option value="school8">Nimitz El</option>
            <option value="school8">Pearl Harbor Kai El</option>
            <option value="school8">Pohakea El</option>
            <option value="school8">Waipahu High</option>

        <script type="text/javascript">


	    var lineClasses = {"August":"August", "September":"September", "October":"October", "November":"November",
			               "December":"December", "January":"January", "March":"March", "February":"February",
			               "April":"April", "May":"May", "June":"June", "July":"July"};

        var school = "Ala Wai El"; //initialize to first school
        var margin = {top: 50, right: 10, bottom: 10, left: 10};
        var w = 130 - margin.left - margin.right;
        var h = 500 - margin.top - margin.bottom; 
        var parser = d3.time.format("%H:%M");

        // x-axis limits
        minTime = parser.parse("00:00");
        maxTime = parser.parse("24:00");

        bisectTime = d3.bisector(function(d) { return d.Time; }).left;

        //create scales
        var xScale =  d3.time.scale()
                            .range([0,w]);
        var yScale = d3.scale.linear()
                            .domain([60, 110]) //y-axis limits
                            .range([h,0]);

	    var line = d3.svg.line() // line function
                    .x(function(d) { return xScale(d.Time); })
            		.y(function(d) { return yScale(d.UTCI_F); });

	                
        //create axes 
        var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom")
            .ticks(3)
            .tickSize(2)
            .tickSubdivide(1)
            .tickFormat(d3.time.format("%H:%M"));;
        
        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(8)
            .tickSize(-2)
            .tickSubdivide(1);


        var schooldat;
	    var nestschooldat;
        d3.csv("data/d3-school.csv", function(error, data) { //load data
            if (error) return console.log(error);
            schooldat = data;
		    schooldat = data.filter(function(d) { return (d.School == school); });

            var minTemp = d3.min(schooldat, function(d) { return d.UTCI_F; }); //define y domain based on school max min UTCI values
            var maxTemp  = d3.max(schooldat, function(d) { return d.UTCI_F; });

            schooldat.forEach (function(d) { 
                d.Time = parser.parse(d.Time); //convert to time format
		       	d.UTCI_F= +d.UTCI_F; //convert to numeric
            });
		
		    nestschooldat = d3.nest() //nest by month
			    .key(function(d) { return d.Month; })
			    .key(function(d) { return d.Alias; })
			    .entries(schooldat);

                	   

		var svg = d3.select("body").selectAll("svg") //add svg element for each month
			.data(nestschooldat)
			.enter().append("svg")
			    .attr("width", w + margin.left + margin.right)
			    .attr("height", h + margin.bottom + margin.top)
			.append("g")
			    .attr("transform", "translate(" + 2*margin.left + "," + margin.top + ")");

        var linesvg = svg.append("g");
        var focus = svg.append("g")
                .style("display", "none");

        linesvg.selectAll("svg")
            .data(function(c) { return c.values; })
            .enter().append("path")
		    .attr("class", "line")
		    .attr("d", function(d) { 
                        yScale.domain([minTemp-5, maxTemp+5]).nice();
                        xScale.domain([minTime, maxTime]).nice(); 
					    return line(d.values); });
            /*.on("mouseover", function(d) {
                d3.select(this)
                    .style("stroke-width", "1px")
                    .style("stroke", "#FF2700");
            })
            .on("mouseout", function(d) {
                d3.select(this)
                    .style("stroke-width", "0.4px")
                    .style("stroke", "#104E8B");
            });*/

        focus.selectAll("svg")
            .data(function(c) { return c.values; })
            .enter().append("circle") //append circle at intersection
            .attr("class", "y")
            .style("fill", "none")
            .style("stroke", "#104E8B")
            .style("stroke-width", "0.4px")
            .style("opacity", 0.6)
            .style("r", 2);

        svg.selectAll("svg")
            .data(function(c) { return c.values; })
            .enter().append("rect") //append rectangle to capture mouse
            .attr("width", w)
            .attr("height", h)
            .style("fill", "none")
            .style("pointer-events", "all")
        .on("mouseover", function() { focus.style("display", null); })
        .on("mouseout", function() { focus.style("display", "none"); })
            .on("mousemove", mousemove);


        svg.append("text")
            .attr("x", w/2)
            .attr("y", -5)
            .style("text-anchor", "middle")
            .text(function(d) { return d.key; });

        // draw axes
        svg.append("g") 
            .attr("class", "x axis") 
            .attr("transform", "translate(0," + h + ")")
            .call(xAxis);
        svg.append("g") 
            .attr("class", "y axis") 
            .attr("transform", "translate(0,0)")
            .call(yAxis);

	function mouseover() {
		focus.attr("opacity", 0.6);
		mousemove.call(this)
	}

	function mouseout() {
		focus.attr("opacity", 0);
	}


        function mousemove() {
            var x0 = xScale.invert(d3.mouse(this)[0]);
		var i=0;
		console.log(x0);
		
		focus.attr("cx", xScale(x0)).attr("cy", function(c) {
				i=bisectTime(c.values, x0, 0, c.values.length-1);
			console.log(i);
			return yScale(function(d) { return d.UTCI_F; }(c.values[i]));
		});
	
	/*			
                i = bisectTime(function(c) { return c.values; }, x0, 1),
                d0 = function(nestedschooldat) { return nestedschooldat.values[i-1]; },
                d1 = function(nestedschooldat) { return nestedschooldat.values[i]; },
                d = x0 - d0.Time > d1.Time - x0 ? d1 : d0;
            console.log(i)
            console.log(d.Time)
            focus.select("circle.y")
                .attr("transform", "translate(" + xScale(d.Time) + "," + yScale(d.UTCI_F) + ")");
*/
        }


	    });	




/*
                // subset by school
                                               
                
                svg.append("g") //scatter
                    .selectAll("circle") 
                    .data(daily.filter(function(d) { return (d.measure == "UTCI" && d.level != "Outdoor"); }), key)
                    .enter()
                    .append("circle")
                    .attr({
                        cx: function(d) { return xScale(d.Date); }, //first column
                        cy: function(d) { return yScale(d.value); }, //second column
                        r: 1.5,
                        fill: function(d) {
                            if (d.measure == "UTCI")
                                if (d.level == "Average") 
                                    return "#30A2DA";
                                else 
                                    return "#FC4F30";
                        },
                        opacity: 0.2
                    })
                    .on("mouseover", function(d) {		
                        toolTip.transition()		
                            .duration(200)		
                            .style("opacity", .9);		
                        toolTip.html(d.Alias + "<br/> UTCI: " + d3.round(d.value,2) + " &deg;F <br/>")	
                            .style("left", (d3.event.pageX) + "px")		
                            .style("top", (d3.event.pageY - 28) + "px");	
                    })					
                    .on("mouseout", function(d) {		
                        toolTip.transition()		
                            .duration(500)		
                            .style("opacity", 0);	
                    });
                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgOutdoorUTCI"); })))
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgOutdoorTemp"); })))
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgSchoolUTCI"); })))
                    .attr("stroke", "#30A2DA")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgSchoolTemp"); })))
                    .attr("stroke", "#30A2DA")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "MaxSchoolUTCI"); })))
                    .attr("stroke", "#FC4F30")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "MaxSchoolTemp"); })))
                    .attr("stroke", "#FC4F30")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))


                //loess smoothing 
                svg.selectAll("path")
                    .data([smoothed])
                    .enter()
                    .append("path")
                    .attr("d", lineFunction)
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none");

                var outUTCI = daily.filter(function(d) { return (d.variable == "AvgOutdoorUTCI"); });
                console.log(outUTCI);

                var xValues = outUTCI.map(function (d){ return d.Date; });
                var yValues = outUTCI.map(function (d){ return d.value; });
                var loess = science.stats.loess().bandwidth(0.6);

                var smoothed = loess(xValues, yValues).map(function (yValue, i){
                    return {
                        Date: outUTCI[i].Date,
                        value: yValue
                    };
                });





                buttons.on("click", function(d) {
                    d3.select(".selected")
                        .classed("selected", false);

                    d3.select(this)
                        .classed("selected", true);
                    
                    school = d;
		    daily = data.filter(function(d) { return (d.School == school || d.School == "Outdoor"); });
                    console.log(daily);


                    var circles = svg.selectAll("circle")
                        .data(daily.filter(function(d) { return (d.measure == "UTCI" && d.level != "Outdoor"); }), key)


                    circles.enter()
                        .append("circle")
                        .attr({
                            cx: function(d) { return xScale(d.Date); }, //first column
                            cy: function(d) { return yScale(d.value); }, //second column
                            r: 1.5,
                            fill: function(d) {
                                if (d.measure == "UTCI")
                                    if (d.level == "Average") 
                                        return "#30A2DA";
                                    else 
                                        return "#FC4F30";
                            },
                            opacity: 0.2
                        })
                        .on("mouseover", function(d) {		
                            toolTip.transition()		
                                .duration(200)		
                                .style("opacity", .9);		
                            toolTip.html(d.Alias + "<br/> UTCI: " + d3.round(d.value,2) + " &deg;F <br/>")	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY - 28) + "px");	
                        })					
                        .on("mouseout", function(d) {		
                            toolTip.transition()		
                                .duration(500)		
                                .style("opacity", 0);	
                        });

                    circles.transition()
                        .duration(500)
                        .attr({
                            cx: function(d) { return xScale(d.Date); }, //first column
                            cy: function(d) { return yScale(d.value); }, //second column
                            r: 1.5,
                            fill: function(d) {
                                if (d.measure == "UTCI")
                                    if (d.level == "Average") 
                                        return "#30A2DA";
                                    else 
                                        return "#FC4F30";
                            },
                            opacity: 0.2
                        });



                    circles.exit()
                        .remove();


                });

            });
       */

        </script>
    </body>
</html>
