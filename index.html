<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>HIDOE Thermal Comfort Analysis</title>
        <script type="text/javascript" src="d3/d3.js"></script>
        <script type="text/javascript" src="science.js-master/science.v1.js"></script>
        <style type="text/css">

            body {
                font-family: Helvetica;
                font-size: 10px;
                color: #535353;
            }

            h2 {
                margin-left: 10px;
            }
            
            .axis path,
            .axis line {
                fill: none;
                stroke: dimgrey;
                shape-rendering: crispEdges;
            }
            .axis text {
                font-family: Helvetica;
                font-size: 10px;
                color: #535353;
                    
            }


            .tooltip {	
                position: absolute;			    
                text-align: center;			
                font-size: 8px;
                width: 100px;					
                height: 28px;					
                padding: 2px;				
                border: 0px;		
                border-radius: 8px;			
                pointer-events: none;			
            }
            
            .button {
                float: left;
                margin-left: 20px;
                font-weight: lighter;
                cursor: pointer;
                
            }

            .buttons-container {
                width: 500;
                margin-bottom: 20px;
            }

            .selected {
                font-weight: bold;
            }

        </style>
    </head>
    <body>
        <script type="text/javascript">
            var school = "Campbell";
            var schools = ["Campbell", "Ilima", "Kaimiloa"];

            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            var w = 1000 - margin.left - margin.right;
            var h = 600 - margin.top - margin.bottom; 


            d3.select("body")
                .append("h2")
                .text("Daily Universal Thermal Climate Index (UTCI) Profile");

            var buttons = d3.select("body")
                .append("div")
                .attr("class", "buttons-container")
                .selectAll("div")
                .data(schools)
                .enter()
                .append("div")
                .text(function(d) { return d; })
                .attr("class", function(d) {
                    if (d == school)
                        return "button selected";
                    else 
                        return "button";
                });



            //create SVG element
            var svg = d3.select("body")
                .append("svg")
                    .attr("width", w + margin.left + margin.right)
                    .attr("height", h + margin.bottom + margin.top)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
	                .attr("width", w)
	                .attr("height", h)

            var toolTip = d3.select("body").append("div")	
                .attr("class", "tooltip")				
                .style("opacity", 0);


            var parser = d3.time.format("%Y-%m-%d");
            
			//Define key function, to be used when binding data
			var key = function(d) {
				return d.ID;
			};


            var daily; 
            d3.csv("daily.csv", function(error, data) { //load data
                if (error) return console.log(error);
                daily = data;
                daily.forEach (function(d) { 
                    d.Date = parser.parse(d.Date); //convert to date format
                    d.value = +d.value; //convert to numeric
                    d.smooth = +d.smooth; //convert to numeric
                });

                // subset by school
                daily = data.filter(function(d) { return (d.School == school || d.School == "Outdoor"); });
                console.log(daily);
                                
                

                //create scales
                var minDate = d3.time.day.offset(daily[0].Date, -10); //with padding 
                var maxDate = d3.time.day.offset(daily[daily.length-1].Date,10);
    
                var xScale =  d3.time.scale()
                                 .domain([minDate, maxDate])
                                 .range([0,w]);
                var yScale = d3.scale.linear()
                                 .domain([60, 110])
                                 .range([h,0]);

                //create axes 
                var xAxis = d3.svg.axis()
                            .scale(xScale)
                            .orient("bottom")
                            .ticks(10);
        
                var yAxis = d3.svg.axis()
                            .scale(yScale)
                            .orient("left")
                            .ticks(15);
                
                svg.append("g") //scatter
                    .selectAll("circle") 
                    .data(daily.filter(function(d) { return (d.measure == "UTCI" && d.level != "Outdoor"); }), key)
                    .enter()
                    .append("circle")
                    .attr({
                        cx: function(d) { return xScale(d.Date); }, //first column
                        cy: function(d) { return yScale(d.value); }, //second column
                        r: 1.5,
                        fill: function(d) {
                            if (d.measure == "UTCI")
                                if (d.level == "Average") 
                                    return "#30A2DA";
                                else 
                                    return "#FC4F30";
                        },
                        opacity: 0.2
                    })
                    .on("mouseover", function(d) {		
                        toolTip.transition()		
                            .duration(200)		
                            .style("opacity", .9);		
                        toolTip.html(d.Alias + "<br/> UTCI: " + d3.round(d.value,2) + " &deg;F <br/>")	
                            .style("left", (d3.event.pageX) + "px")		
                            .style("top", (d3.event.pageY - 28) + "px");	
                    })					
                    .on("mouseout", function(d) {		
                        toolTip.transition()		
                            .duration(500)		
                            .style("opacity", 0);	
                    });

                var lineFunction = d3.svg.line()
                                        .interpolate("basis")
                                        .x(function(d) { return xScale(d.Date); })
                                        .y(function(d) { return yScale(d.smooth); });

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgOutdoorUTCI"); })))
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgOutdoorTemp"); })))
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgSchoolUTCI"); })))
                    .attr("stroke", "#30A2DA")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "AvgSchoolTemp"); })))
                    .attr("stroke", "#30A2DA")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "MaxSchoolUTCI"); })))
                    .attr("stroke", "#FC4F30")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none")

                svg.append("path")
                    .attr("d", lineFunction(daily.filter(function(d) { return (d.variable == "MaxSchoolTemp"); })))
                    .attr("stroke", "#FC4F30")
                    .attr("stroke-width", "0.8")
                    .attr("fill", "none")
                    .style("stroke-dasharray", ("5, 5"))

/*
                //loess smoothing 
                svg.selectAll("path")
                    .data([smoothed])
                    .enter()
                    .append("path")
                    .attr("d", lineFunction)
                    .attr("stroke", "dimgrey")
                    .attr("stroke-width", "1.2")
                    .attr("fill", "none");

                var outUTCI = daily.filter(function(d) { return (d.variable == "AvgOutdoorUTCI"); });
                console.log(outUTCI);

                var xValues = outUTCI.map(function (d){ return d.Date; });
                var yValues = outUTCI.map(function (d){ return d.value; });
                var loess = science.stats.loess().bandwidth(0.6);

                var smoothed = loess(xValues, yValues).map(function (yValue, i){
                    return {
                        Date: outUTCI[i].Date,
                        value: yValue
                    };
                });
*/

                // draw axes
                svg.append("g") 
                    .attr("class", "x axis") 
                    .attr("transform", "translate(0," + h + ")")
                    .call(xAxis);
                svg.append("g") 
                    .attr("class", "y axis") 
                    .attr("transform", "translate(0,0)")
                    .call(yAxis);


                buttons.on("click", function(d) {
                    d3.select(".selected")
                        .classed("selected", false);

                    d3.select(this)
                        .classed("selected", true);
                    
                    school = d;
		    daily = data.filter(function(d) { return (d.School == school || d.School == "Outdoor"); });
                    console.log(daily);


                    var circles = svg.selectAll("circle")
                        .data(daily.filter(function(d) { return (d.measure == "UTCI" && d.level != "Outdoor"); }), key)


                    circles.enter()
                        .append("circle")
                        .attr({
                            cx: function(d) { return xScale(d.Date); }, //first column
                            cy: function(d) { return yScale(d.value); }, //second column
                            r: 1.5,
                            fill: function(d) {
                                if (d.measure == "UTCI")
                                    if (d.level == "Average") 
                                        return "#30A2DA";
                                    else 
                                        return "#FC4F30";
                            },
                            opacity: 0.2
                        })
                        .on("mouseover", function(d) {		
                            toolTip.transition()		
                                .duration(200)		
                                .style("opacity", .9);		
                            toolTip.html(d.Alias + "<br/> UTCI: " + d3.round(d.value,2) + " &deg;F <br/>")	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY - 28) + "px");	
                        })					
                        .on("mouseout", function(d) {		
                            toolTip.transition()		
                                .duration(500)		
                                .style("opacity", 0);	
                        });

                    circles.transition()
                        .duration(500)
                        .attr({
                            cx: function(d) { return xScale(d.Date); }, //first column
                            cy: function(d) { return yScale(d.value); }, //second column
                            r: 1.5,
                            fill: function(d) {
                                if (d.measure == "UTCI")
                                    if (d.level == "Average") 
                                        return "#30A2DA";
                                    else 
                                        return "#FC4F30";
                            },
                            opacity: 0.2
                        });



                    circles.exit()
                        .remove();


                });

            });
       

        </script>
    </body>
</html>
